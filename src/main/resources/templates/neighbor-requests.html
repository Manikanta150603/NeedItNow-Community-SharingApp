<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neighbor Requests - NeedItNow</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
    /* Reset and base styles */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

body {
    background: #000;
    min-height: 100vh;
    position: relative;
    overflow-x: hidden;
}

/* Background effects */
.bg-gradient {
    position: fixed;
    inset: 0;
    background: linear-gradient(to bottom, rgba(168, 85, 247, 0.4), rgba(147, 51, 234, 0.5), #000);
    z-index: -3;
}

.noise-overlay {
    position: fixed;
    inset: 0;
    opacity: 0.03;
    mix-blend-mode: soft-light;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
    background-size: 200px 200px;
    z-index: -2;
}

.glow-top {
    position: fixed;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 120vh;
    height: 60vh;
    border-radius: 0 0 50% 50%;
    background: rgba(192, 132, 252, 0.2);
    filter: blur(80px);
    z-index: -1;
}

.glow-middle {
    position: fixed;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 100vh;
    height: 60vh;
    border-radius: 0 0 100% 100%;
    background: rgba(216, 180, 254, 0.2);
    filter: blur(60px);
    animation: pulse-middle 8s ease-in-out infinite alternate;
    z-index: -1;
}

.glow-bottom {
    position: fixed;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 90vh;
    height: 90vh;
    border-radius: 100% 100% 0 0;
    background: rgba(192, 132, 252, 0.2);
    filter: blur(60px);
    animation: pulse-bottom 6s ease-in-out 1s infinite alternate;
    z-index: -1;
}

/* Add background elements to body */
body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: linear-gradient(to bottom, rgba(168, 85, 247, 0.4), rgba(147, 51, 234, 0.5), #000);
    z-index: -3;
}

body::after {
    content: '';
    position: fixed;
    inset: 0;
    opacity: 0.03;
    mix-blend-mode: soft-light;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
    background-size: 200px 200px;
    z-index: -2;
}

/* Dashboard Header */
.dashboard-header {
    background: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    padding: 2rem 0;
    position: relative;
    z-index: 10;
}

.dashboard-header::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(168, 85, 247, 0.1) 0%, transparent 50%);
    pointer-events: none;
}

.dashboard-header .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1rem;
    position: relative;
    z-index: 1;
}

.dashboard-header h1 {
    font-size: 2rem;
    font-weight: bold;
    background: linear-gradient(to bottom, #fff, rgba(255, 255, 255, 0.8));
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    margin-bottom: 0.5rem;
    animation: slide-up 0.8s ease forwards;
}

.dashboard-header p {
    color: rgba(255, 255, 255, 0.7);
    font-size: 1rem;
    animation: slide-up 0.8s ease 0.2s forwards;
    opacity: 0;
}

/* Back Button */
.back-btn {
    display: inline-flex;
    align-items: center;
    padding: 0.75rem 1.5rem;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(5px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 0.5rem;
    color: #fff;
    text-decoration: none;
    font-weight: 500;
    transition: all 0.3s ease;
    margin-bottom: 1.5rem;
    animation: slide-up 0.8s ease 0.1s forwards;
    opacity: 0;
}

.back-btn:hover {
    background: rgba(255, 255, 255, 0.15);
    transform: translateY(-2px);
    color: #fff;
}

.back-btn:active {
    transform: translateY(0);
}

/* Container */
.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1rem;
}

/* Content Area */
.content {
    position: relative;
    z-index: 5;
    padding: 2rem 0;
}

/* Button alignment - Right side with spacing from header */
.d-flex.justify-content-between.align-items-center.mb-4 {
    justify-content: flex-end !important;
    margin-top: 2rem !important; /* Add space between header and buttons */
    padding-top: 1rem; /* Additional padding for visual separation */
}

.d-flex.justify-content-between.align-items-center.mb-4 > div {
    margin-left: auto;
}

/* Card Styles - Updated for your HTML structure */
.card {
    background: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 1rem;
    overflow: hidden;
    transition: all 0.3s ease;
    position: relative;
    animation: slide-up 0.8s ease forwards;
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
}

.card::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
    border-radius: 1rem;
}

.card:hover {
    transform: translateY(-5px);
    border-color: rgba(168, 85, 247, 0.3);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
}

.card:hover::before {
    opacity: 1;
}

/* Card styling adjustments for consistent look */
.request-card,
.card {
    background: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 1rem;
    overflow: hidden;
    transition: all 0.3s ease;
    position: relative;
    animation: slide-up 0.8s ease forwards;
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
    height: auto;
    min-height: 500px;
    max-width: 400px;
    min-height: 500px;
    margin: 0 auto 1.5rem;
    margin-bottom: 0.5rem; /* Reduced from 1rem to 0.5rem */
}

.request-card::before,
.card::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
    border-radius: 1rem;
}

.request-card:hover,
.card:hover {
    transform: translateY(-5px);
    border-color: rgba(168, 85, 247, 0.3);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
}

.request-card:hover::before,
.card:hover::before {
    opacity: 1;
}

/* Card Images */
.card-img-top,
.request-image {
    width: 100%;
    height: 200px;
    object-fit: cover;
    border-radius: 0;
    transition: transform 0.3s ease;
}

.card:hover .card-img-top,
.request-card:hover .request-image {
    transform: scale(1.05);
}

/* Card Body */
.card-body {
    padding: 1.25rem;
    display: flex;
    flex-direction: column;
    min-height: 280px;
    flex-grow: 1;
}

.card-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: #fff;
    margin-bottom: 0.75rem;
    line-height: 1.3;
}

.card-text {
    color: rgba(255, 255, 255, 0.8);
    line-height: 1.5;
    margin-bottom: 1rem;
}

.card-text.small {
    font-size: 0.875rem;
    color: rgba(255, 255, 255, 0.7);
}

/* Badge styling */
.badge {
    position: relative;
    z-index: 2;
}

.urgency-badge {
    position: absolute;
    top: 0.75rem;
    right: 0.75rem;
    z-index: 3;
    font-size: 0.75rem;
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
}

.status-badge {
    position: absolute;
    top: 0.75rem;
    left: 0.75rem;
    z-index: 3;
    font-size: 0.75rem;
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
}

/* Button Styling */
.btn {
    border-radius: 0.5rem;
    font-weight: 500;
    transition: all 0.3s ease;
    border: 1px solid transparent;
    position: relative;
    overflow: hidden;
}

.btn::after {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(to right, rgba(255, 255, 255, 0), rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0));
    transform: translateX(-100%);
    transition: transform 0.6s ease;
}

.btn:hover::after {
    transform: translateX(100%);
}

.btn:hover {
    transform: translateY(-2px);
}

.btn-outline-primary {
    background: rgba(168, 85, 247, 0.2);
    color: #a855f7;
    border: 1px solid rgba(168, 85, 247, 0.3);
}

.btn-outline-primary:hover {
    background: rgba(168, 85, 247, 0.3);
    color: #fff;
    border-color: rgba(168, 85, 247, 0.5);
}

.btn-outline-secondary {
    background: rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.8);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.btn-outline-secondary:hover {
    background: rgba(255, 255, 255, 0.2);
    color: #fff;
    border-color: rgba(255, 255, 255, 0.3);
}

.btn-primary {
    background: rgba(168, 85, 247, 0.8);
    color: #fff;
    border: 1px solid rgba(168, 85, 247, 0.9);
}

.btn-primary:hover {
    background: rgba(168, 85, 247, 0.9);
    border-color: rgba(168, 85, 247, 1);
}

.btn-respond {
    background: rgba(168, 85, 247, 0.2);
    color: #a855f7;
    border: 1px solid rgba(168, 85, 247, 0.3);
}

.btn-respond:hover {
    background: rgba(168, 85, 247, 0.3);
    color: #fff;
}

.btn-secondary {
    background: rgba(255, 255, 255, 0.2);
    color: #fff;
    border: 1px solid rgba(255, 255, 255, 0.3);
}

.btn-secondary:hover {
    background: rgba(255, 255, 255, 0.3);
}

/* Dropdown styling */
.dropdown-menu {
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 0.5rem;
    padding: 0.5rem 0;
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
}

.dropdown-item {
    color: rgba(255, 255, 255, 0.8);
    padding: 0.5rem 1rem;
    border: none;
    background: transparent;
    width: 100%;
    text-align: left;
    transition: all 0.3s ease;
}

.dropdown-item:hover {
    background: rgba(168, 85, 247, 0.2);
    color: #fff;
}

.dropdown-divider {
    border-color: rgba(255, 255, 255, 0.2);
}

/* Alert styling */
.alert {
    background: rgba(13, 202, 240, 0.2);
    border: 1px solid rgba(13, 202, 240, 0.3);
    border-radius: 0.5rem;
    color: #0dcaf0;
    padding: 1rem;
    margin-bottom: 1.5rem;
    animation: slide-up 0.8s ease forwards;
}

.alert-info {
    background: rgba(13, 202, 240, 0.2);
    border: 1px solid rgba(13, 202, 240, 0.3);
    color: #0dcaf0;
}

.alert-warning {
    background: rgba(255, 193, 7, 0.2);
    border: 1px solid rgba(255, 193, 7, 0.3);
    color: #ffc107;
}

/* Modal styling */
.modal-content {
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 1rem;
    color: #fff;
}

.modal-header {
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    background: rgba(168, 85, 247, 0.8);
}

.modal-body {
    color: rgba(255, 255, 255, 0.9);
}

.modal-footer {
    border-top: 1px solid rgba(255, 255, 255, 0.2);
}

/* Form controls */
.form-control {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: #fff;
    border-radius: 0.5rem;
}

.form-control:focus {
    background: rgba(255, 255, 255, 0.15);
    border-color: rgba(168, 85, 247, 0.5);
    color: #fff;
    box-shadow: 0 0 0 0.2rem rgba(168, 85, 247, 0.25);
}

.form-control::placeholder {
    color: rgba(255, 255, 255, 0.5);
}

/* Chat styling */
.chat-container {
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.2) !important;
}

.chat-messages {
    color: rgba(255, 255, 255, 0.8);
}

.system-message {
    color: rgba(255, 255, 255, 0.5) !important;
}

/* Utility Classes */
.d-flex {
    display: flex !important;
}

.justify-content-between {
    justify-content: space-between !important;
}

.align-items-center {
    align-items: center !important;
}

.gap-2 {
    gap: 0.5rem !important;
}

.mt-2 {
    margin-top: 0.5rem !important;
}

.mt-4 {
    margin-top: 1.5rem !important;
}

.mt-auto {
    margin-top: auto !important;
}

.mb-0 {
    margin-bottom: 0 !important;
}

.mb-3 {
    margin-bottom: 1rem !important;
}

.mb-4 {
    margin-bottom: 1.5rem !important;
}

.me-1 {
    margin-right: 0.25rem !important;
}

.me-2 {
    margin-right: 0.5rem !important;
}

.ms-2 {
    margin-left: 0.5rem !important;
}

.flex-grow-1 {
    flex-grow: 1 !important;
}

.text-white-50 {
    color: rgba(255, 255, 255, 0.5) !important;
}

.text-muted {
    color: rgba(255, 255, 255, 0.6) !important;
}

.text-success {
    color: #22c55e !important;
}

.text-dark {
    color: #000 !important;
}

.h3 {
    font-size: 1.75rem !important;
}

.small {
    font-size: 0.875rem !important;
}

.d-none {
    display: none !important;
}

.d-grid {
    display: grid !important;
}

.bg-light {
    background: rgba(255, 255, 255, 0.1) !important;
}

.bg-success {
    background: rgba(34, 197, 94, 0.8) !important;
}

.bg-danger {
    background: rgba(239, 68, 68, 0.8) !important;
}

.bg-warning {
    background: rgba(255, 193, 7, 0.8) !important;
}

.bg-info {
    background: rgba(13, 202, 240, 0.8) !important;
}

.bg-primary {
    background: rgba(168, 85, 247, 0.8) !important;
}

/* Grid system */
.row {
    display: flex;
    flex-wrap: wrap;
    margin: -0.375rem; /* Reduced from -0.75rem to -0.375rem */
}

.col {
    padding: 0.375rem; /* Reduced from 0.75rem to 0.375rem */
    flex: 0 0 auto;
    width: 100%;
}

.col-md-8 {
    flex: 0 0 auto;
    width: 66.666667%;
}

.col-md-4 {
    flex: 0 0 auto;
    width: 33.333333%;
}

.row-cols-1 > .col {
    flex: 0 0 auto;
    width: 100%;
}

.row-cols-md-2 > .col {
    flex: 0 0 auto;
    width: 50%;
}

.row-cols-lg-3 > .col {
    flex: 0 0 auto;
    width: 33.333333%;
}

.g-4 {
    --bs-gutter-x: 0.75rem; /* Reduced from 1.5rem to 0.75rem */
    --bs-gutter-y: 0.75rem; /* Reduced from 1.5rem to 0.75rem */
}

.g-4 > .col {
    padding-right: calc(var(--bs-gutter-x) * 0.5);
    padding-left: calc(var(--bs-gutter-x) * 0.5);
    margin-top: var(--bs-gutter-y);
}

.h-100 {
    height: 100% !important;
}

/* Specific grid adjustments for request cards */
.row-cols-1.row-cols-md-2.row-cols-lg-3.g-4 {
    --bs-gutter-x: 0.5rem;  /* Reduced from 1rem to 0.5rem for tighter spacing */
    --bs-gutter-y: 0.5rem;  /* Reduced from 1rem to 0.5rem for tighter spacing */
}

/* Animations */
@keyframes slide-up {
    from { 
        opacity: 0; 
        transform: translateY(20px); 
    }
    to { 
        opacity: 1; 
        transform: translateY(0); 
    }
}

@keyframes pulse-middle {
    0%, 100% { 
        opacity: 0.15; 
        transform: translateX(-50%) scale(0.98); 
    }
    50% { 
        opacity: 0.3; 
        transform: translateX(-50%) scale(1.02); 
    }
}

@keyframes pulse-bottom {
    0%, 100% { 
        opacity: 0.3; 
        transform: translateX(-50%) scale(1); 
    }
    50% { 
        opacity: 0.5; 
        transform: translateX(-50%) scale(1.1); 
    }
}

/* Responsive Design */
@media (min-width: 768px) {
    .row-cols-md-2 > .col {
        width: 50%;
    }
    
    .row-cols-md-3 > .col {
        width: 33.333333%;
    }
    
    .col-md-8 {
        width: 66.666667%;
    }
    
    .col-md-4 {
        width: 33.333333%;
    }
}

@media (min-width: 992px) {
    .row-cols-lg-3 > .col {
        width: 33.333333%;
    }
}

@media (max-width: 768px) {
    .dashboard-header {
        padding: 1rem 0;
    }
    
    .dashboard-header h1 {
        font-size: 1.5rem;
    }
    
    .col {
        width: 100% !important;
    }
    
    .col-md-8,
    .col-md-4 {
        width: 100% !important;
    }
    
    .container {
        padding: 0 0.5rem;
    }
    
    .card-body {
        padding: 1rem;
    }

    .row-cols-1.row-cols-md-2.row-cols-lg-3.g-4 {
        --bs-gutter-x: 0.5rem; /* Maintain tighter spacing on mobile */
        --bs-gutter-y: 0.5rem;
    }
    
    .card,
    .request-card {
        margin-bottom: 0.5rem; /* Maintain reduced margin on mobile */
    }
    
    /* Reduce space between buttons and header on mobile */
    .d-flex.justify-content-between.align-items-center.mb-4 {
        margin-top: 1.5rem !important;
        padding-top: 0.5rem;
    }
}

@media (max-width: 480px) {
    .dashboard-header {
        padding: 0.75rem 0;
    }
    
    .dashboard-header h1 {
        font-size: 1.25rem;
    }
    
    .back-btn {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
    }
    
    /* Further reduce spacing on very small screens */
    .d-flex.justify-content-between.align-items-center.mb-4 {
        margin-top: 1rem !important;
        padding-top: 0.25rem;
    }
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .card,
    .request-card {
        max-width: 100%; /* Full width on mobile */
        min-height: auto; /* Allow height to adjust on mobile */
    }
    
    .card-img-top.request-image {
        height: 180px; /* Slightly smaller image on mobile */
    }
}
    </style>
</head>
<body>
    <!-- Define currentUserId and communityId -->
    <script>
        // Initialize variables
        let currentUserId = /*[[${session.user?.id}]]*/ null;
        const communityId = /*[[${communityId}]]*/ '1';
        console.log('Initial User ID from session:', currentUserId);

        // Initialize chat functionality
        document.addEventListener('DOMContentLoaded', function() {
            // First check if we have user ID from session
            if (currentUserId) {
                console.log('User ID from session:', currentUserId);
                initializeChat();
                return;
            }

            // If not, try to fetch from API
            console.log('Fetching user data from API');
            fetch('/user/api/current-user', {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    console.log('User not logged in:', data.error);
                    showLoginMessage();
                    return;
                }
                
                currentUserId = data.id;
                console.log('Fetched currentUserId:', currentUserId);
                initializeChat();
            })
            .catch(error => {
                console.error('Error fetching user data:', error);
                showLoginMessage();
            });
        });

        function showLoginMessage() {
            const chatButton = document.getElementById('chatButton');
            if (chatButton) {
                chatButton.disabled = true;
                chatButton.title = 'Please log in to start a chat';
            }
        }

        function initializeChat() {
            const chatButton = document.getElementById('chatButton');
            if (chatButton) {
                chatButton.disabled = false;
                chatButton.title = '';

                // Add click handler
                chatButton.addEventListener('click', function() {
                    const modal = new bootstrap.Modal(document.getElementById('chatModal'));
                    if (modal) {
                        modal.show();
                    }
                });
            }
        }
    </script>

    <!-- Header -->
    <div class="dashboard-header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <a th:href="@{/user/community/} + ${community.id} + '/share-circle'" class="back-btn">
                        <i class="fas fa-arrow-left me-2"></i> Back to ShareCircle
                    </a>
                    <h1 class="h3 mb-0">
                        <i class="fas fa-hands-helping"></i></i>Help a Neighbour
                    </h1>
                    <p class="mb-0 text-white-50">View and respond to neighbour Requests</p>
                </div>
            </div>
        </div>
    </div>
  
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            
            <div>
                <a th:href="@{/user/community/{id}/items/my-requests(id=${communityId})}" class="btn btn-outline-primary">
                    <i class="fas fa-clipboard-list me-1"></i> My Requests
                </a>
                <a th:href="@{/user/community/{id}/share-circle(id=${communityId})}" class="btn btn-outline-secondary ms-2">
                    <i class="fas fa-arrow-left me-1"></i> Back to ShareCircle
                </a>
            </div>
        </div>
        
        <div class="alert alert-info" th:if="${requestItems.isEmpty()}">
            <i class="fas fa-info-circle me-2"></i> There are currently no active requests from your neighbors. Check back later!
        </div>
        
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" th:if="${!requestItems.isEmpty()}">
            <div class="col" th:each="request : ${requestItems}">
                <div class="card h-100 request-card">
                    <div th:if="${request.urgency == 'Very Urgent'}" class="urgency-badge badge bg-danger">Very Urgent</div>
                    <div th:if="${request.urgency == 'Somewhat Urgent'}" class="urgency-badge badge bg-warning text-dark">Somewhat Urgent</div>
                    <div th:if="${request.urgency == 'Not Urgent'}" class="urgency-badge badge bg-info">Not Urgent</div>
                    <div th:if="${request.acceptor != null}" class="status-badge badge bg-success">Accepted</div>
                    
                    <img th:if="${request.photoDataBase64 != null}" th:src="'data:image/jpeg;base64,' + ${request.photoDataBase64}"
                         class="card-img-top request-image" alt="Request Image">
                    <img th:if="${request.photoDataBase64 == null}" 
                         src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjE4MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjE4MCIgZmlsbD0iI2YwZjBmMCIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMjAiIGZpbGw9IiM2NjY2NjYiIGR5PSIuM2VtIiB0ZXh0LWFuY2hvcj0icmVnZXgiPjx0c3Bhbj5Ob3cgSW1hZ2U8L3RzcGFuPjwvdGV4dD48L3N2Zz4="
                         class="card-img-top request-image" alt="No Image">
                    
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title" th:text="${request.title}">Request Title</h5>
                        <p class="card-text small text-muted">
                            <i class="fas fa-tag me-1"></i> <span th:text="${request.category}">Category</span>
                            <span class="ms-2">
                                <i class="fas fa-clock me-1"></i> 
                                <span th:if="${request.createdAt != null}" th:text="${#temporals.format(request.createdAt, 'MMM dd, yyyy')}">Jan 1, 2025</span>
                            </span>
                        </p>
                        <p class="card-text" th:text="${request.description}">Description of the request goes here...</p>
                        
                        <div class="mt-auto">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <span th:if="${request.displayName}" class="small">
                                        <i class="fas fa-user me-1"></i> <span th:text="${request.requester.fullName}">Username</span>
                                    </span>
                                    <span th:unless="${request.displayName}" class="small">
                                        <i class="fas fa-user-secret me-1"></i> Anonymous
                                    </span>
                                </div>
                                <div class="dropdown" th:if="${request.acceptor == null}">
                                    <button class="btn btn-respond dropdown-toggle" type="button" id="respondDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fas fa-reply me-1"></i> Respond
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="respondDropdown">
                                        <li>
                                            <form th:action="@{/user/community/{communityId}/neighbor/request/{requestId}/accept(communityId=${communityId}, requestId=${request.id})}" method="post">
                                                <button type="submit" class="dropdown-item"><i class="fas fa-check-circle me-1 text-success"></i> Accept Request</button>
                                            </form>
                                        </li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li>
                                            <button class="dropdown-item" 
                                                    th:data-request-id="${request.id}"
                                                    th:data-request-title="${request.title}"
                                                    th:data-requester-name="${request.displayName ? request.requester.fullName : 'Anonymous'}"
                                                    th:data-allow-phone="${request.allowPhone}"
                                                    th:data-user-id="${request.requester.id}"
                                                    onclick="showCallInfo(this)">
                                                <i class="fas fa-phone me-1"></i> Call
                                            </button>
                                        </li>

                                        <li>
                                            <button class="dropdown-item chat-button" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#chatModal"
                                                    th:data-request-id="${request.id}"
                                                    th:data-request-title="${request.title}"
                                                    th:data-user-id="${request.requester.id}">
                                                <i class="fas fa-comments me-1"></i> Chat
                                            </button>
                                        </li>
                                    </ul>
                                </div>
                                <div th:if="${request.acceptor != null}" class="d-flex align-items-center">
                                    <span class="badge bg-success me-2"><i class="fas fa-check-circle me-1"></i> Accepted</span>
                                    <button class="btn btn-sm btn-primary" 
                                            th:data-request-id="${request.id}"
                                            th:data-requester-id="${request.requester.id}"
                                            data-bs-toggle="modal" 
                                            data-bs-target="#chatModal"
                                            onclick="openChatModal(this)">
                                        <i class="fas fa-comment-dots me-1"></i> Message
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Call Info Modal -->
    <div class="modal fade" id="callInfoModal" tabindex="-1" aria-labelledby="callInfoModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title" id="callInfoModalLabel">Call Information</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="phoneAllowed" class="d-none">
                        <p><strong>Neighbor Name:</strong> <span id="requesterName"></span></p>
                        <p><strong>Phone Number:</strong> <span id="requesterPhone"></span></p>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i> 
                            When calling, please mention you're contacting them about their request on NeedItNow.
                        </div>
                    </div>
                    <div id="phoneNotAllowed" class="d-none">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i> 
                            This neighbor has not allowed phone contact. Please use the chat option instead.
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <a id="callButton" href="tel:5551234567" class="btn btn-primary d-none">
                        <i class="fas fa-phone me-1"></i> Call Now
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Modal -->
    <div class="modal fade" id="chatModal" tabindex="-1" aria-labelledby="chatModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="chatModalLabel">Chat about Request</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="chatRequestId">
                    <input type="hidden" id="chatReceiverId">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="chat-container border rounded p-3 mb-3" style="height: 300px; overflow-y: auto;">
                                <div class="chat-messages">
                                    <div class="system-message text-center text-muted small mb-3">
                                        <em>This is the beginning of your conversation about this request.</em>
                                    </div>
                                </div>
                            </div>
                            <div class="input-group">
                                <input type="text" id="chatMessage" class="form-control" placeholder="Type your message..." autocomplete="off">
                                <button class="btn btn-primary" id="sendChatMessage" type="button">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header bg-light">Request Details</div>
                                <div class="card-body">
                                    <h6 id="chatRequestTitle" class="card-title">Request Title</h6>
                                    <p class="card-text small">You can chat with the neighbor about this request and arrange details.</p>
                                    <div class="d-grid">
                                        <form id="acceptRequestForm" th:action="@{/user/community/{communityId}/items/accept-request(communityId=${communityId})}" method="POST">
                                            <input type="hidden" id="acceptRequestId" name="requestId">
                                            
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Current User ID -->
    <script th:inline="javascript">
        // Set global variables
        window.currentUserId = /*[[${currentUserId}]]*/ null;
        window.communityId = /*[[${communityId}]]*/ null;
        
        // Log for debugging
        console.log('Current User ID:', window.currentUserId);
        console.log('Community ID:', window.communityId);
    </script>
    
    <script>
        // Function to show call information
        function showCallInfo(button) {
            const requestId = button.getAttribute('data-request-id');
            const requestTitle = button.getAttribute('data-request-title');
            const requesterName = button.getAttribute('data-requester-name');
            const allowPhone = button.getAttribute('data-allow-phone') === 'true';
            const userId = button.getAttribute('data-user-id');
            
            document.getElementById('callInfoModalLabel').textContent = 'Call about: ' + requestTitle;
            document.getElementById('requesterName').textContent = requesterName;
            
            if (allowPhone) {
                console.log('Fetching phone for user ID:', userId);
                fetch(`/user/community/${window.communityId}/items/api/users/${userId}/phone`, {
                    credentials: 'include'
                })
                .then(response => response.json())
                .then(data => {
                    const phoneNumber = data.phoneNumber || '(Phone not available)';
                    document.getElementById('requesterPhone').textContent = phoneNumber;
                    document.getElementById('callButton').href = 'tel:' + phoneNumber;
                })
                .catch(error => {
                    document.getElementById('requesterPhone').textContent = '(Phone not available)';
                    console.error('Error fetching phone number:', error);
                });
                
                document.getElementById('phoneAllowed').classList.remove('d-none');
                document.getElementById('phoneNotAllowed').classList.add('d-none');
                document.getElementById('callButton').classList.remove('d-none');
            } else {
                document.getElementById('phoneAllowed').classList.add('d-none');
                document.getElementById('phoneNotAllowed').classList.remove('d-none');
                document.getElementById('callButton').classList.add('d-none');
            }
            
            var callInfoModal = new bootstrap.Modal(document.getElementById('callInfoModal'));
            callInfoModal.show();
        }
        
        // Add the openChatModal function to handle chat button clicks
        function openChatModal(button) {
            const requestId = button.getAttribute('data-request-id');
            const requestTitle = button.getAttribute('data-request-title') || 'Request';
            const receiverId = button.getAttribute('data-requester-id');
            
            console.log(`Opening chat modal for request: ${requestId}, receiver: ${receiverId}, title: ${requestTitle}`);
            
            // Set hidden input values for the chat form
            document.getElementById('chatRequestId').value = requestId;
            document.getElementById('chatReceiverId').value = receiverId;
            
            // Set the chat title
            document.getElementById('chatModalLabel').textContent = 'Chat about: ' + requestTitle;
        }
        
        // Chat storage
        let chatHistory = {};
        
        // Enable/disable send button based on input
        const chatMessageInput = document.getElementById('chatMessage');
        const sendButton = document.getElementById('sendChatMessage');
        
        if (chatMessageInput && sendButton) {
            // Enable/disable button based on input
            chatMessageInput.addEventListener('input', function() {
                sendButton.disabled = !this.value.trim();
            });
            
            // Also check on focus in case the value was set programmatically
            chatMessageInput.addEventListener('focus', function() {
                sendButton.disabled = !this.value.trim();
            });
        }
        
        // Load chat history from localStorage
        document.addEventListener('DOMContentLoaded', function() {
            try {
                const savedChats = localStorage.getItem('chatHistory');
                if (savedChats) {
                    chatHistory = JSON.parse(savedChats);
                    console.log('Loaded chat history:', chatHistory);
                }
            } catch (e) {
                console.error('Error loading chat history:', e);
            }
        });
        
        // Set up chat modal
        const chatModal = document.getElementById('chatModal');
        if (chatModal) {
            chatModal.addEventListener('show.bs.modal', function (event) {
                if (!window.currentUserId) {
                    alert('Please log in to start a chat.');
                    event.preventDefault();
                    return;
                }
                const button = event.relatedTarget;
                const requestId = button.getAttribute('data-request-id');
                const requestTitle = button.getAttribute('data-request-title');
                const receiverId = button.getAttribute('data-user-id');
                
                document.getElementById('chatRequestId').value = requestId;
                document.getElementById('chatReceiverId').value = receiverId;
                document.getElementById('acceptRequestId').value = requestId;
                document.getElementById('chatRequestTitle').textContent = requestTitle;
                document.getElementById('chatModalLabel').textContent = 'Chat about: ' + requestTitle;
                
                const chatMessagesContainer = document.querySelector('.chat-messages');
                while (chatMessagesContainer.children.length > 0) {
                    chatMessagesContainer.removeChild(chatMessagesContainer.lastChild);
                }
                
                const systemMsg = document.createElement('div');
                systemMsg.className = 'system-message text-center text-muted small mb-3';
                systemMsg.innerHTML = '<em>This is the beginning of your conversation about this request.</em>';
                chatMessagesContainer.appendChild(systemMsg);
                
                // Show loading indicator
                const loadingIndicator = document.createElement('div');
                loadingIndicator.className = 'text-center p-3';
                loadingIndicator.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>';
                chatMessagesContainer.appendChild(loadingIndicator);
                
                // First display locally cached messages for better perceived performance
                if (chatHistory[requestId] && chatHistory[requestId].length > 0) {
                    chatHistory[requestId].forEach(msg => {
                        addChatMessage(msg.sender, msg.text, msg.isFromCurrentUser, false);
                    });
                }
                
                // Fetch messages from the server
                console.log(`Fetching chat history for request ${requestId}, current user ${window.currentUserId}`);
                fetch(`/user/community/${window.communityId}/neighbor/request/${requestId}/responses`)
                    .then(async response => {
                        if (!response.ok) {
                            const errorText = await response.text();
                            throw new Error(`Server returned ${response.status}: ${errorText}`);
                        }
                        try {
                            return await response.json();
                        } catch (e) {
                            console.error('Failed to parse JSON response:', e);
                            throw new Error('Invalid response format from server');
                        }
                    })
                    .then(messagesMap => {
                        console.log('Fetched messages from server:', messagesMap);
                        
                        // Remove loading indicator
                        loadingIndicator.remove();
                        
                        // Clear existing messages
                        while (chatMessagesContainer.children.length > 1) {
                            chatMessagesContainer.removeChild(chatMessagesContainer.lastChild);
                        }
                        chatMessagesContainer.appendChild(systemMsg);
                        
                        // The response is a map of senderId -> messages or an array of messages
                        const isEmpty = !messagesMap || 
                                     (typeof messagesMap === 'object' && 
                                      !Array.isArray(messagesMap) && 
                                      Object.keys(messagesMap).length === 0);
                                      
                        // If we got an array instead of a map, convert it to the expected format
                        if (Array.isArray(messagesMap)) {
                            console.log('Received array of messages, converting to map format');
                            const newMap = {};
                            messagesMap.forEach(msg => {
                                const senderId = (msg.sender && (msg.sender.id || msg.sender)) || 'unknown';
                                if (!newMap[senderId]) {
                                    newMap[senderId] = [];
                                }
                                newMap[senderId].push(msg);
                            });
                            messagesMap = newMap;
                        }
                        if (!isEmpty) {
                            // Flatten messages from all senders
                            let allMessages = [];
                            for (const [senderId, messages] of Object.entries(messagesMap)) {
                                allMessages = allMessages.concat(messages);
                            }
                            
                            // Sort messages by timestamp
                            allMessages.sort((a, b) => new Date(a.sentAt) - new Date(b.sentAt));
                            
                            // Display all messages
                            allMessages.forEach(msg => {
                                // Handle both string and object sender formats
                                let senderId = null;
                                let senderName = 'Unknown';
                                
                                if (msg.sender) {
                                    // Handle case where sender is an object with id and name
                                    if (typeof msg.sender === 'object') {
                                        senderId = msg.sender.id || null;
                                        senderName = msg.sender.name || 'Neighbor';
                                    } 
                                    // Handle case where sender is just an ID
                                    else if (typeof msg.sender === 'string' || typeof msg.sender === 'number') {
                                        senderId = msg.sender;
                                        senderName = 'Neighbor';
                                    }
                                }
                                
                                const isFromCurrentUser = senderId && senderId.toString() === window.currentUserId.toString();
                                const displayName = isFromCurrentUser ? 'You' : senderName;
                                const messageText = msg.message || msg.text || '';
                                
                                // Only add to UI if we have message content
                                if (messageText) {
                                    addChatMessage(displayName, messageText, isFromCurrentUser, false);
                                    
                                    // Update local cache
                                    if (!chatHistory[requestId]) {
                                        chatHistory[requestId] = [];
                                    }
                                    
                                    // Add to cache if not already there
                                    const messageExists = chatHistory[requestId].some(
                                        m => m.text === messageText && 
                                           m.isFromCurrentUser === isFromCurrentUser
                                    );
                                    
                                    if (!messageExists) {
                                        chatHistory[requestId].push({
                                            sender: displayName,
                                            text: messageText,
                                            isFromCurrentUser: isFromCurrentUser,
                                            timestamp: msg.sentAt || new Date().toISOString()
                                        });
                                    }
                                }
                            });
                            
                            // Save updated chat history to localStorage
                            localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
                        } else if (chatHistory[requestId] && chatHistory[requestId].length > 0) {
                            // If no messages from server but we have cached messages, show those
                            chatHistory[requestId].forEach(msg => {
                                addChatMessage(msg.sender, msg.text, msg.isFromCurrentUser, false);
                            });
                        }
                        
                        // Scroll to bottom
                        const chatContainer = document.querySelector('.chat-container');
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                    })
                    .catch(error => {
                        console.error('Error fetching chat messages:', error);
                        loadingIndicator.remove();
                        
                        // Show error message
                        const errorMsg = document.createElement('div');
                        errorMsg.className = 'alert alert-danger';
                        errorMsg.textContent = 'Failed to load messages. Please try again.';
                        chatMessagesContainer.appendChild(errorMsg);
                        
                        // If we have cached messages, show them
                        if (chatHistory[requestId] && chatHistory[requestId].length > 0) {
                            const cacheMsg = document.createElement('div');
                            cacheMsg.className = 'alert alert-warning mt-2';
                            cacheMsg.textContent = 'Showing cached messages.';
                            chatMessagesContainer.appendChild(cacheMsg);
                            
                            chatHistory[requestId].forEach(msg => {
                                addChatMessage(msg.sender, msg.text, msg.isFromCurrentUser, false);
                            });
                        }
                    });
            });
        }
        
        // Handle sending chat messages
        document.addEventListener('DOMContentLoaded', function() {
            const sendChatButton = document.getElementById('sendChatMessage');
            const chatMessageInput = document.getElementById('chatMessage');
            let isSending = false; // Flag to prevent multiple sends
            
            if (!sendChatButton || !chatMessageInput) {
                console.error('Required chat elements not found');
                return;
            }
            
            // Handle send button click
            sendChatButton.addEventListener('click', handleSendMessage);
            
            // Handle Enter key in message input
            chatMessageInput.addEventListener('keyup', function(event) {
                if (event.key === 'Enter') {
                    handleSendMessage();
                }
            });
            
            async function handleSendMessage() {
                // Prevent multiple sends
                if (isSending) return;
                isSending = true;
                const message = chatMessageInput.value.trim();
                const requestId = document.getElementById('chatRequestId')?.value;
                const receiverId = document.getElementById('chatReceiverId')?.value;
                
                if (!message) {
                    alert('Please enter a message');
                    return;
                }
                
                if (!requestId || !receiverId) {
                    console.error('Missing requestId or receiverId');
                    alert('Error: Unable to send message. Please try again.');
                    return;
                }
                
                // Disable send button while sending
                const originalButtonText = sendChatButton.innerHTML;
                sendChatButton.disabled = true;
                sendChatButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Sending...';
                
                console.log('Sending message:', { requestId, message, receiverId });
                
                try {
                    const response = await fetch(`/user/community/${window.communityId}/neighbor/message/send`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: new URLSearchParams({
                            requestId: requestId,
                            message: message,
                            receiverId: receiverId
                        }),
                        credentials: 'include'
                    });
                    
                    const responseText = await response.text();
                    console.log('Server response:', response.status, responseText);
                    
                    if (!response.ok) {
                        throw new Error(`Failed to send message: ${response.status} ${response.statusText}`);
                    }
                    
                    let responseData = {};
                    try {
                        responseData = responseText ? JSON.parse(responseText) : {};
                    } catch (e) {
                        console.warn('Failed to parse JSON response:', e);
                    }
                    
                    console.log('Message sent successfully:', responseData);
                    
                    // Clear input field
                    chatMessageInput.value = '';
                    
                    // Add message to UI using our helper function
                    saveAndDisplayMessage(
                        requestId,
                        'You',
                        message,
                        true
                    );
                    
                    // Update the last message time
                    const lastMessageTime = document.querySelector('.last-message-time');
                    if (lastMessageTime) {
                        lastMessageTime.textContent = 'Just now';
                    }
                    
                    // If this was the first message, trigger a refresh of the chat history
                    const chatMessages = document.querySelectorAll('.chat-message:not(.system-message)');
                    if (chatMessages.length <= 1) {
                        const chatModal = document.getElementById('chatModal');
                        if (chatModal) {
                            const modal = bootstrap.Modal.getInstance(chatModal);
                            if (modal) {
                                modal.hide();
                                modal.show();
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error sending message:', error);
                    alert('Failed to send message: ' + (error.message || 'Unknown error occurred'));
                } finally {
                    // Re-enable send button
                    sendChatButton.disabled = false;
                    sendChatButton.innerHTML = originalButtonText;
                    isSending = false; // Reset the flag
                }
            }
        });
        
        // Helper function to save and display message
        function saveAndDisplayMessage(requestId, sender, text, isFromCurrentUser) {
            if (!chatHistory[requestId]) {
                chatHistory[requestId] = [];
            }
            
            const messageObj = {
                sender: sender,
                text: text,
                isFromCurrentUser: isFromCurrentUser,
                timestamp: new Date().toISOString()
            };
            
            chatHistory[requestId].push(messageObj);
            
            addChatMessage(sender, text, isFromCurrentUser, true);
            
            try {
                localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
            } catch (e) {
                console.log('Could not save chat history to localStorage', e);
            }
        }
        
        // Function to add chat message to UI
        function addChatMessage(sender, text, isFromCurrentUser, scrollToBottom = true) {
            const chatMessagesContainer = document.querySelector('.chat-messages');
            if (!chatMessagesContainer) {
                console.error('Chat messages container not found');
                return;
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message mb-2 ' + (isFromCurrentUser ? 'text-end' : '');
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content p-2 rounded ' + 
                                    (isFromCurrentUser ? 'bg-primary text-white' : 'bg-light');
            messageContent.style.display = 'inline-block';
            messageContent.style.maxWidth = '80%';
            
            // Create message header with sender name and timestamp
            const messageHeader = document.createElement('div');
            messageHeader.className = 'd-flex justify-content-between align-items-center mb-1';
            
            const senderName = document.createElement('small');
            senderName.className = 'fw-bold' + (isFromCurrentUser ? ' text-white' : '');
            senderName.textContent = sender;
            
            const messageTime = document.createElement('small');
            messageTime.className = isFromCurrentUser ? 'text-white-50' : 'text-muted';
            messageTime.textContent = 'Just now';
            
            messageHeader.appendChild(senderName);
            messageHeader.appendChild(messageTime);
            
            // Create message text
            const messageText = document.createElement('div');
            messageText.className = 'message-text';
            messageText.textContent = text;
            
            // Assemble the message
            messageContent.appendChild(messageHeader);
            messageContent.appendChild(messageText);
            
            messageDiv.appendChild(messageContent);
            chatMessagesContainer.appendChild(messageDiv);
            
            if (scrollToBottom) {
                const chatContainer = document.querySelector('.chat-container');
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }
    </script>
</body>
</html>