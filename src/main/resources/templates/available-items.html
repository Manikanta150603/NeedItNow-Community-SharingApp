<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>What's Available - NeedItNow</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
       /* What's Available Page Styling - Matching Index Theme */

/* Reset and base styles */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

body {
    background: #000;
    min-height: 100vh;
    color: #fff;
    position: relative;
}

/* Background effects matching index page */
body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: linear-gradient(to bottom, rgba(168, 85, 247, 0.4), rgba(147, 51, 234, 0.5), #000);
    z-index: -3;
}

body::after {
    content: '';
    position: fixed;
    inset: 0;
    opacity: 0.03;
    mix-blend-mode: soft-light;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
    background-size: 200px 200px;
    z-index: -2;
}

/* Gradient glows */
.glow-top {
    position: fixed;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 120vh;
    height: 60vh;
    border-radius: 0 0 50% 50%;
    background: rgba(192, 132, 252, 0.2);
    filter: blur(80px);
    z-index: -1;
}

.glow-middle {
    position: fixed;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 100vh;
    height: 60vh;
    border-radius: 0 0 100% 100%;
    background: rgba(216, 180, 254, 0.2);
    filter: blur(60px);
    animation: pulse-middle 8s ease-in-out infinite alternate;
    z-index: -1;
}

.glow-bottom {
    position: fixed;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 90vh;
    height: 90vh;
    border-radius: 100% 100% 0 0;
    background: rgba(192, 132, 252, 0.2);
    filter: blur(60px);
    animation: pulse-bottom 6s ease-in-out 1s infinite alternate;
    z-index: -1;
}

/* Dashboard Header */
.dashboard-header {
    background: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    padding: 2rem 0;
    margin-bottom: 2rem;
}

.dashboard-header .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1rem;
}

.back-btn {
    display: inline-flex;
    align-items: center;
    color: rgba(255, 255, 255, 0.7);
    text-decoration: none;
    font-size: 0.9rem;
    margin-bottom: 1rem;
    transition: color 0.3s ease;
    background: rgba(255, 255, 255, 0.05);
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    backdrop-filter: blur(5px);
}

.back-btn:hover {
    color: #fff;
    background: rgba(255, 255, 255, 0.1);
}

.dashboard-header h1 {
    font-size: 2rem;
    font-weight: bold;
    background: linear-gradient(to bottom, #fff, rgba(255, 255, 255, 0.8));
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    margin-bottom: 0.5rem;
}

.dashboard-header p {
    color: rgba(255, 255, 255, 0.6);
    font-size: 1rem;
}

/* Container */
.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1rem;
}

/* Filter Section */
.filter-section {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.05);
    border-radius: 1rem;
    padding: 1.5rem;
    margin-bottom: 2rem;
    animation: slide-up 0.8s ease forwards;
}

/* Input Groups */
.input-group {
    position: relative;
}

.input-group-text {
    position: absolute;
    left: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    color: rgba(255, 255, 255, 0.4);
    background: none;
    border: none;
    z-index: 2;
}

.form-control, .form-select {
    width: 100%;
    height: 2.5rem;
    padding: 0.5rem 0.75rem 0.5rem 2.5rem;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 0.5rem;
    color: #fff;
    font-size: 0.9rem;
    outline: none;
    transition: all 0.3s ease;
}

.form-select {
    padding-left: 0.75rem;
    cursor: pointer;
}

.form-control:focus, .form-select:focus {
    background: rgba(255, 255, 255, 0.1);
    border-color: rgba(168, 85, 247, 0.5);
    box-shadow: 0 0 0 0.2rem rgba(168, 85, 247, 0.25);
}

.form-control::placeholder {
    color: rgba(255, 255, 255, 0.3);
}

/* Filter Pills */
.filter-tabs {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    padding: 0;
    margin: 0;
    list-style: none;
}

.nav-item {
    margin: 0;
}

.nav-link {
    display: block;
    padding: 0.5rem 1rem;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 2rem;
    color: rgba(255, 255, 255, 0.7);
    text-decoration: none;
    font-size: 0.85rem;
    font-weight: 500;
    transition: all 0.3s ease;
    white-space: nowrap;
}

.nav-link:hover {
    background: rgba(255, 255, 255, 0.1);
    color: #fff;
    border-color: rgba(255, 255, 255, 0.2);
}

.nav-link.active {
    background: linear-gradient(135deg, rgba(168, 85, 247, 0.8), rgba(147, 51, 234, 0.8));
    color: #fff;
    border-color: rgba(168, 85, 247, 0.5);
}

/* Item Grid */
#itemGrid {
    animation: slide-up 0.8s ease 0.2s forwards;
    opacity: 0;
}

.row {
    display: flex;
    flex-wrap: wrap;
    margin: -0.25rem;
    width: calc(100% + 0.5rem);
}

.col, .col-md-4 {
    flex: 0 0 auto;
    width: 50%;
    padding: 0.5rem;
    display: flex;
}

@media (min-width: 768px) {
    .col-md-4 {
        width: 33.333333%;
    }
}

/* Item Cards */
.item-card {
    background: rgba(255, 255, 255, 0.08); /* Slightly more transparent */
    backdrop-filter: blur(15px); /* Increased blur */
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 1.25rem; /* More rounded */
    overflow: hidden;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); /* Smoother transition */
    height: 100%;
    display: flex;
    width: 100%;
    flex-direction: column;
    position: relative;
    max-width: 320px; /* Limit maximum width */
}

.item-card:hover {
    transform: translateY(-8px) scale(1.02); /* Enhanced hover effect */
    background: rgba(255, 255, 255, 0.15);
    border-color: rgba(168, 85, 247, 0.3);
    box-shadow: 0 20px 40px rgba(168, 85, 247, 0.15), 0 10px 25px rgba(0, 0, 0, 0.3);
}

.item-img {
    width: 100%;
    height: 160px; /* Reduced from 200px */
    object-fit: cover;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 0.75rem 0.75rem 0 0; /* Modern rounded corners */
    transition: transform 0.3s ease;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
}

.item-img.placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(147, 51, 234, 0.2));
    color: rgba(255, 255, 255, 0.6);
    font-size: 2rem;
    border: 2px dashed rgba(255, 255, 255, 0.2);
}

.item-img.placeholder::before {
    content: '\f03e'; /* Font Awesome image icon */
    font-family: 'Font Awesome 6 Free';
    font-weight: 900;
}

.item-card:hover .item-img {
    transform: scale(1.02); /* Subtle zoom on hover */
}

.item-body {
    padding: 1.25rem;
    flex: 1;
    display: flex;
    flex-direction: column;
}

.item-title {
    font-size: 1rem;
    font-weight: 600;
    color: #fff;
    margin-bottom: 0.75rem;
    line-height: 1.3;
}

.item-meta {
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.6);
    margin-bottom: 0.75rem;
}

.item-description {
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.7);
    margin-bottom: 1rem;
    flex: 1;
    line-height: 1.4;
}

.item-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: auto;
}

/* Action Dropdown */
.action-dropdown {
    position: relative;
}

.btn-want {
    background: linear-gradient(135deg, rgba(168, 85, 247, 0.8), rgba(147, 51, 234, 0.8));
    color: #fff;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    font-size: 0.85rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-want:hover {
    transform: scale(1.05);
    background: linear-gradient(135deg, rgba(168, 85, 247, 1), rgba(147, 51, 234, 1));
}

.action-dropdown-content {
    position: absolute;
    bottom: 100%;
    right: 0;
    background: rgba(0, 0, 0, 0.9);
    backdrop-filter: blur(15px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 0.75rem;
    min-width: 200px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
    opacity: 0;
    visibility: hidden;
    transform: translateY(10px);
    transition: all 0.3s ease;
    z-index: 100;
    margin-bottom: 0.5rem;
}

.action-dropdown-content.show {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.action-dropdown-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    color: rgba(255, 255, 255, 0.8);
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9rem;
}

.action-dropdown-item:hover {
    background: rgba(255, 255, 255, 0.1);
    color: #fff;
}

.action-dropdown-item.danger:hover {
    background: rgba(231, 76, 60, 0.2);
    color: #e74c3c;
}

.action-dropdown-item:first-child {
    border-radius: 0.75rem 0.75rem 0 0;
}

.action-dropdown-item:last-child {
    border-radius: 0 0 0.75rem 0.75rem;
}

.action-dropdown-item i {
    width: 16px;
    text-align: center;
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: rgba(255, 255, 255, 0.6);
}

.empty-state i {
    font-size: 4rem;
    margin-bottom: 1rem;
    color: rgba(255, 255, 255, 0.3);
}

.empty-state h4 {
    font-size: 1.5rem;
    color: rgba(255, 255, 255, 0.8);
    margin-bottom: 0.5rem;
}

/* Chat Popup */
.chat-popup {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    width: 350px;
    height: 500px;
    background: rgba(0, 0, 0, 0.9);
    backdrop-filter: blur(15px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 1rem;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6);
    display: flex;
    flex-direction: column;
    opacity: 0;
    visibility: hidden;
    transform: translateY(20px) scale(0.95);
    transition: all 0.3s ease;
    z-index: 1000;
}

.chat-popup.show {
    opacity: 1;
    visibility: visible;
    transform: translateY(0) scale(1);
}

.chat-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    background: rgba(255, 255, 255, 0.05);
    border-radius: 1rem 1rem 0 0;
}

.chat-header h4 {
    color: #fff;
    font-size: 1rem;
    font-weight: 600;
    margin: 0;
}

.chat-close {
    background: none;
    border: none;
    color: rgba(255, 255, 255, 0.6);
    cursor: pointer;
    padding: 0.25rem;
    border-radius: 0.25rem;
    transition: all 0.3s ease;
}

.chat-close:hover {
    color: #fff;
    background: rgba(255, 255, 255, 0.1);
}

.chat-body {
    flex: 1;
    padding: 1rem;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.chat-message {
    max-width: 80%;
    padding: 0.75rem;
    border-radius: 1rem;
    font-size: 0.9rem;
    line-height: 1.4;
    word-wrap: break-word;
}

.chat-message.sent {
    align-self: flex-end;
    background: linear-gradient(135deg, rgba(168, 85, 247, 0.8), rgba(147, 51, 234, 0.8));
    color: #fff;
    border-bottom-right-radius: 0.25rem;
}

.chat-message.received {
    align-self: flex-start;
    background: rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.9);
    border-bottom-left-radius: 0.25rem;
}

.chat-footer {
    display: flex;
    padding: 1rem;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    gap: 0.5rem;
}

.chat-input {
    flex: 1;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 0.5rem;
    padding: 0.5rem 0.75rem;
    color: #fff;
    font-size: 0.9rem;
    outline: none;
    transition: all 0.3s ease;
}

.chat-input:focus {
    background: rgba(255, 255, 255, 0.1);
    border-color: rgba(168, 85, 247, 0.5);
}

.chat-input::placeholder {
    color: rgba(255, 255, 255, 0.3);
}

.chat-send {
    background: linear-gradient(135deg, rgba(168, 85, 247, 0.8), rgba(147, 51, 234, 0.8));
    border: none;
    border-radius: 0.5rem;
    padding: 0.5rem 0.75rem;
    color: #fff;
    cursor: pointer;
    transition: all 0.3s ease;
}

.chat-send:hover {
    background: linear-gradient(135deg, rgba(168, 85, 247, 1), rgba(147, 51, 234, 1));
    transform: scale(1.05);
}

/* Contact Modal */
.contact-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(10px);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 2000;
    animation: fadeIn 0.3s ease;
}

.contact-modal > div {
    background: rgba(0, 0, 0, 0.9) !important;
    backdrop-filter: blur(15px);
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    color: #fff !important;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6);
}

.contact-modal h3 {
    color: #fff !important;
    background: linear-gradient(to bottom, #fff, rgba(255, 255, 255, 0.8));
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent !important;
}

.contact-modal p {
    color: rgba(255, 255, 255, 0.8) !important;
}

.contact-modal div[style*="background: #f8f9fa"] {
    background: rgba(255, 255, 255, 0.05) !important;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.contact-modal a {
    background: linear-gradient(135deg, rgba(76, 175, 80, 0.8), rgba(56, 142, 60, 0.8)) !important;
    transition: all 0.3s ease;
}

.contact-modal a:hover {
    background: linear-gradient(135deg, rgba(76, 175, 80, 1), rgba(56, 142, 60, 1)) !important;
    transform: scale(1.05);
}

.contact-modal button {
    background: rgba(255, 255, 255, 0.1) !important;
    color: rgba(255, 255, 255, 0.8) !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    transition: all 0.3s ease;
}

.contact-modal button:hover {
    background: rgba(255, 255, 255, 0.2) !important;
    color: #fff !important;
}


* {
    scrollbar-width: thin;
    scrollbar-color: rgba(168, 85, 247, 0.5) rgba(255, 255, 255, 0.05);
}

*::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

*::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 10px;
}

*::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, rgba(168, 85, 247, 0.6), rgba(147, 51, 234, 0.6));
    border-radius: 10px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

*::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, rgba(168, 85, 247, 0.8), rgba(147, 51, 234, 0.8));
}

*::-webkit-scrollbar-corner {
    background: rgba(255, 255, 255, 0.05);
}








/* Animations */
@keyframes slide-up {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes pulse-middle {
    0%, 100% { opacity: 0.15; transform: translateX(-50%) scale(0.98); }
    50% { opacity: 0.3; transform: translateX(-50%) scale(1.02); }
}

@keyframes pulse-bottom {
    0%, 100% { opacity: 0.3; transform: translateX(-50%) scale(1); }
    50% { opacity: 0.5; transform: translateX(-50%) scale(1.1); }
}

/* Responsive Design */
@media (max-width: 768px) {
    .container {
        padding: 0 0.5rem;
    }
    
    .dashboard-header {
        padding: 1.5rem 0;
    }
    
    .dashboard-header h1 {
        font-size: 1.5rem;
    }
    
    .filter-section {
        padding: 1rem;
    }
    
    .filter-tabs {
        justify-content: center;
    }
    
    .nav-link {
        font-size: 0.8rem;
        padding: 0.4rem 0.8rem;
    }
    
    .col {
        width: 100%;
    }
    
    .chat-popup {
        width: calc(100vw - 2rem);
        height: calc(100vh - 4rem);
        bottom: 1rem;
        right: 1rem;
        left: 1rem;
    }
    
    .item-actions {
        flex-direction: column;
        align-items: stretch;
        gap: 0.75rem;
    }
    
    .action-dropdown-content {
        position: static;
        opacity: 1;
        visibility: visible;
        transform: none;
        margin: 0.5rem 0 0 0;
        box-shadow: none;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .action-dropdown-content.show {
        display: block;
    }
}

@media (min-width: 576px) {
    .col, .col-md-4 {
        width: 33.333%; /* 3 columns on small tablets */
    }
}

@media (min-width: 992px) {
    .col, .col-md-4 {
        width: 25%; /* 4 columns on larger screens */
    }
}

/* Ensure the grid container takes full width */
#itemGrid > div {
    width: 100%;
}


/* Scrollbar Styling */
.chat-body::-webkit-scrollbar {
    width: 6px;
}

.chat-body::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 3px;
}

.chat-body::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 3px;
}

.chat-body::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.3);
}
    </style>
</head>
<body>


    <div class="dashboard-header">
        <div class="container">
            <a th:href="@{/user/community/{communityId}/share-circle(communityId=${communityId})}" class="back-btn">
                <i class="fas fa-arrow-left me-2"></i> Back to ShareCircle
            </a>
            <h1 class="h3 mb-0">
                <i class="fas fa-box-open me-2"></i>What's Available
            </h1>
            <p class="mb-0 text-white-50">Browse items shared by your community</p>
        </div>
    </div>

    <div class="container mt-4">
        <div class="filter-section">
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" class="form-control" id="searchBar" placeholder="Search by item name">
                    </div>
                </div>
                <div class="col-md-6">
                    <select class="form-select" id="categoryFilter">
                        <option value="">All Categories</option>
                        <option value="Food & Beverages">Food & Beverages</option>
                        <option value="Home Essentials">Home Essentials</option>
                        <option value="Personal Care">Personal Care</option>
                        <option value="Stationery">Stationery</option>
                        <option value="Baby & Kids">Baby & Kids</option>
                        <option value="Pet Supplies">Pet Supplies</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
            </div>
            <ul class="nav nav-pills filter-tabs mt-3">
                <li class="nav-item">
                    <a class="nav-link active" href="#" data-filter="all">All</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-filter="free">Free</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-filter="postedToday">Posted Today</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-filter="closeToDisappear">Close to Disappear</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-filter="highQuantity">High Quantity</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-filter="withPhotos">With Photos</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-filter="recentlyActive">Recently Active</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-filter="lowPrice">Low Price</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-filter="contactFriendly">Contact Friendly</a>
                </li>
            </ul>
        </div>

        <div id="itemGrid">
            <div th:if="${items} and ${items.size() > 0}">
                <div class="row row-cols-1 row-cols-md-3 g-4" style="align-items: stretch;">
                    <div class="col" th:each="item : ${_items}" th:if="${item != null}">
                        <div class="item-card">
                            <div th:if="${item.photoDataBase64 != null}">
    <img th:src="'data:image/jpeg;base64,' + ${item.photoDataBase64}" class="item-img" alt="Item Image" />
</div>
<div th:unless="${item.photoDataBase64 != null}" class="item-img placeholder" title="No image available"></div>
                            <div class="item-body">
                                <h5 class="item-title" th:text="${item.itemName != null ? item.itemName : 'Unnamed Item'}">Item Name</h5>
                                <div class="item-meta">
                                    <span th:text="'Category: ' + ${item.category != null ? item.category : 'None'}">Category</span> |
                                    <span th:text="'Quantity: ' + ${item.availableQuantity}">Quantity</span>
                                </div>
                                <div class="item-description" th:text="${item.additionalNotes != null ? item.additionalNotes : ''}">Description</div>
                                <div class="item-actions">
                                    <div class="item-meta" style="margin-bottom: 0;">
                                        <span th:if="${item.isFree}">Free</span>
                                        <span th:unless="${item.isFree}" th:text="'Price: ₹' + ${item.price != null ? item.price : '0.00'}">Price</span>
                                    </div>
                                    <div class="action-dropdown">
                                        <button class="btn-want" onclick="toggleDropdown(this)">
                                            <i class="fas fa-hand-holding-heart"></i> Want
                                        </button>
                                        <div class="action-dropdown-content" th:id="'dropdown-' + ${item.itemName.replaceAll('\\s+', '-').toLowerCase()}">
                                            <div th:if="${item.allowPhone}" class="action-dropdown-item" 
                                                 th:attr="data-phone=${item.user != null ? item.user.phoneNumber : ''},
                                                         data-item-name=${#strings.replace(item.itemName, '\'', '\\\''')},
                                                         data-owner-name=${item.user != null && item.user.fullName != null ? #strings.replace(item.user.fullName, '\'', '\\\'') : 'Unknown'},
                                                         data-item-id=${item.id},
                                                         data-owner-id=${item.user != null ? item.user.id : 0}"
                                                 onclick="handleCallOwner(this)">
                                                <i class="fas fa-phone-alt"></i>
                                                <span>Call Owner</span>
                                            </div>
                                            <div class="action-dropdown-item" th:onclick="'handleAction(\'chat\', \'' + ${#strings.replace(item.itemName, '\'', '\\\'')} + '\', \'' + ${item.user != null && item.user.fullName != null ? #strings.replace(item.user.fullName, '\'', '\\\'') : 'Unknown'} + '\', ' + ${item.id} + ', ' + ${item.user != null ? item.user.id : 0} + ')'">
                                                <i class="fas fa-comment-alt"></i>
                                                <span>Chat with Owner</span>
                                            </div>
                                            <div th:unless="${item.requester != null}" class="action-dropdown-item" th:onclick="'requestItem(' + ${item.id} + ')'">
                                                <i class="fas fa-hand-paper"></i>
                                                <span>Request Item</span>
                                            </div>
                                            <div class="action-dropdown-item danger" th:onclick="'handleAction(\'cancel\', \'' + ${item.itemName} + '\')'">
                                                <i class="fas fa-times"></i>
                                                <span>Cancel</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div th:unless="${items} and ${items.size() > 0}" class="empty-state">
                <i class="fas fa-box-open"></i>
                <h4>No items available</h4>
                <p>Check back later or share an item in ShareCircle!</p>
            </div>
        </div>
    </div>

    <!-- Chat Popup Container -->
    <div id="chatPopup" class="chat-popup">
        <div class="chat-header">
            <h4 id="chatTitle">Chat</h4>
            <button class="chat-close" onclick="closeChatPopup()"><i class="fas fa-times"></i></button>
        </div>
        <div id="chatBody" class="chat-body">
            <!-- Messages will be appended here -->
        </div>
        <div class="chat-footer">
            <input type="text" id="chatInput" class="chat-input" placeholder="Type a message..." onkeypress="if(event.key === 'Enter') sendMessage()">
            <button class="chat-send" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function() {
            const items = [
                /*[# th:each="item, iterStat : ${items}" th:if="${item != null}"]*/
                    {
                        id: [[${item.id}]],
                        itemName: [[${item.itemName != null ? item.itemName : ''}]],
                        category: [[${item.category != null ? item.category : ''}]],
                        availableQuantity: [[${item.availableQuantity}]],
                        additionalNotes: [[${item.additionalNotes != null ? item.additionalNotes : ''}]],
                        free: [[${item.isFree}]],
                        price: [[${item.price != null ? item.price.toString() : '0.00'}]],
                        dateOfPosting: [[${item.dateOfPosting != null ? item.dateOfPosting : ''}]],
                        autoRemoveAfter: [[${item.autoRemoveAfter}]] || null,
                        autoRemoveUnit: [[${item.autoRemoveUnit != null ? item.autoRemoveUnit : ''}]],
                        photoData: [[${item.photoDataBase64 != null ? item.photoDataBase64 : ''}]],
                        allowPhone: [[${item.isAllowPhone}]],
                        ownerName: [[${item.user != null && item.user.fullName != null ? item.user.fullName : 'Unknown'}]],
                        ownerId: [[${item.user != null ? item.user.id : 0}]],
                        ownerPhone: [[${item.user != null && item.user.phoneNumber != null ? item.user.phoneNumber : ''}]]
                    }/*[# th:unless="${iterStat.last}"]*/,/*[/]*/
                /*[/]*/
            ];

            const currentUserId = [[${currentUserId}]];
            const communityId = [[${communityId}]];

            const itemGrid = document.getElementById('itemGrid');
            const searchBar = document.getElementById('searchBar');
            const categoryFilter = document.getElementById('categoryFilter');
            const filterTabs = document.querySelectorAll('.filter-tabs .nav-link');

            let activeFilter = 'all';

            function renderItems(filteredItems) {
                if (filteredItems.length === 0) {
                    itemGrid.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-box-open"></i>
                            <h4>No items match your filters</h4>
                            <p>Try adjusting your search or filters!</p>
                        </div>
                    `;
                    return;
                }

                let html = '<div class="row row-cols-1 row-cols-md-3 g-4" style="align-items: stretch;">';
                filteredItems.forEach(item => {
                    html += `
                        <div class="col">
                            <div class="item-card">
                            ${item.photoData ? `<img src="data:image/jpeg;base64,${item.photoData}" class="item-img" alt="Item Image" />` : `<div class="item-img placeholder" title="No image available"></div>`}
                                <div class="item-body">
                                    <h5 class="item-title">${item.itemName || 'Unnamed Item'}</h5>
                                    <div class="item-meta">
                                        <span>Category: ${item.category || 'None'}</span> |
                                        <span>Quantity: ${item.availableQuantity}</span>
                                    </div>
                                    <div class="item-description">${item.additionalNotes || ''}</div>
                                    <div class="item-actions">
                                        <div class="item-meta" style="margin-bottom: 0;">
                                            ${item.free ? '<span>Free</span>' : `<span>Price: ₹${item.price}</span>`}
                                        </div>
                                        <div class="action-dropdown">
                                            <button class="btn-want" onclick="toggleDropdown(this)">
                                                <i class="fas fa-hand-holding-heart"></i> Want
                                            </button>
                                            <div class="action-dropdown-content" id="dropdown-${item.itemName.replace(/\s+/g, '-').toLowerCase()}">
                                                ${item.allowPhone ? `
                                                <div class="action-dropdown-item" 
                                                     data-phone="${item.ownerPhone}" 
                                                     data-item-name="${item.itemName.replace(/'/g, '\\\'')}" 
                                                     data-owner-name="${item.ownerName.replace(/'/g, '\\\'')}" 
                                                     data-item-id="${item.id}" 
                                                     data-owner-id="${item.ownerId}" 
                                                     onclick="handleCallOwner(this)">
                                                    <i class="fas fa-phone-alt"></i>
                                                    <span>Call Owner</span>
                                                </div>` : ''}
                                                <div class="action-dropdown-item" onclick="handleAction('chat', '${item.itemName.replace(/'/g, '\\\'')}', '${item.ownerName.replace(/'/g, '\\\'')}', ${item.id}, ${item.ownerId})">
                                                    <i class="fas fa-comment-alt"></i>
                                                    <span>Chat with Owner</span>
                                                </div>
                                                <div class="action-dropdown-item" onclick="requestItem(${item.id})">
                                                    <i class="fas fa-hand-paper"></i>
                                                    <span>Request Item</span>
                                                </div>
                                                <div class="action-dropdown-item danger" onclick="handleAction('cancel', '${item.itemName.replace(/'/g, '\\\'')}')">
                                                    <i class="fas fa-times"></i>
                                                    <span>Cancel</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                itemGrid.innerHTML = html;
            }

            function filterItems() {
                let filteredItems = items;
                const searchTerm = searchBar.value.trim().toLowerCase();
                if (searchTerm) {
                    filteredItems = filteredItems.filter(item => 
                        item.itemName.toLowerCase().includes(searchTerm)
                    );
                }
                const selectedCategory = categoryFilter.value;
                if (selectedCategory) {
                    filteredItems = filteredItems.filter(item => 
                        item.category === selectedCategory
                    );
                }
                const now = new Date();
                if (activeFilter === 'free') {
                    filteredItems = filteredItems.filter(item => item.free);
                } else if (activeFilter === 'postedToday') {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    filteredItems = filteredItems.filter(item => {
                        const postDate = new Date(item.dateOfPosting);
                        return postDate >= today;
                    });
                } else if (activeFilter === 'closeToDisappear') {
                    filteredItems = filteredItems.filter(item => {
                        if (!item.autoRemoveAfter || !item.autoRemoveUnit) return false;
                        const postDate = new Date(item.dateOfPosting);
                        const hoursToAdd = item.autoRemoveUnit === 'hours' 
                            ? item.autoRemoveAfter 
                            : item.autoRemoveAfter * 24;
                        const expireDate = new Date(postDate.getTime() + hoursToAdd * 60 * 60 * 1000);
                        const hoursLeft = (expireDate - now) / (1000 * 60 * 60);
                        return hoursLeft <= 2 && hoursLeft > 0;
                    });
                } else if (activeFilter === 'highQuantity') {
                    filteredItems = filteredItems.filter(item => item.availableQuantity >= 5);
                } else if (activeFilter === 'withPhotos') {
                    filteredItems = filteredItems.filter(item => item.photoData);
                } else if (activeFilter === 'recentlyActive') {
                    const oneDayAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);
                    filteredItems = filteredItems.filter(item => {
                        const postDate = new Date(item.dateOfPosting);
                        return postDate >= oneDayAgo;
                    });
                } else if (activeFilter === 'lowPrice') {
                    filteredItems = filteredItems.filter(item => !item.free && parseFloat(item.price) <= 50);
                } else if (activeFilter === 'contactFriendly') {
                    filteredItems = filteredItems.filter(item => item.allowPhone);
                }
                renderItems(filteredItems);
            }

            searchBar.addEventListener('input', filterItems);
            categoryFilter.addEventListener('change', filterItems);
            filterTabs.forEach(tab => {
                tab.addEventListener('click', function(e) {
                    e.preventDefault();
                    filterTabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    activeFilter = this.getAttribute('data-filter');
                    filterItems();
                });
            });

            renderItems(items);

            window.toggleDropdown = function(button) {
                document.querySelectorAll('.action-dropdown-content').forEach(dropdown => {
                    if (dropdown !== button.nextElementSibling) {
                        dropdown.classList.remove('show');
                    }
                });
                const dropdown = button.nextElementSibling;
                dropdown.classList.toggle('show');
                document.addEventListener('click', function closeDropdown(e) {
                    if (!button.contains(e.target) && !dropdown.contains(e.target)) {
                        dropdown.classList.remove('show');
                        document.removeEventListener('click', closeDropdown);
                    }
                });
            };

            window.requestItem = function(itemId) {
                fetch(`/user/community/${communityId}/items/request/${itemId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                })
                .then(response => {
                    if (response.ok) {
                        alert('Item requested successfully!');
                        window.location.reload();
                    } else {
                        alert('Failed to request item.');
                    }
                })
                .catch(error => {
                    console.error('Error requesting item:', error);
                    alert('Error requesting item.');
                });
            };

            window.handleCallOwner = function(element) {
                const phoneNumber = element.getAttribute('data-phone');
                const itemName = element.getAttribute('data-item-name');
                const ownerName = element.getAttribute('data-owner-name');
                const itemId = element.getAttribute('data-item-id');
                const ownerId = element.getAttribute('data-owner-id');
                
                const dropdown = element.closest('.action-dropdown-content');
                dropdown.classList.remove('show');
                
                handleAction('call', itemName, ownerName, itemId, ownerId, phoneNumber);
            };
            
            window.handleAction = function(action, itemName, ownerName, itemId, ownerId, ownerPhone = '') {
                const dropdown = document.getElementById(`dropdown-${itemName.replace(/\s+/g, '-').toLowerCase()}`);
                if (dropdown) {
                    dropdown.classList.remove('show');
                }

                switch(action) {
                    case 'call':
                        const modalHtml = `
                            <div class="contact-modal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000;">
                                <div style="background: white; padding: 24px; border-radius: 12px; max-width: 90%; width: 400px; text-align: center;">
                                    <h3 style="margin-top: 0; color: #333;">Contact Information</h3>
                                    <p style="margin-bottom: 20px; color: #555;">For item: <strong>${itemName}</strong></p>
                                    <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                        <p style="margin: 5px 0;"><i class="fas fa-user" style="margin-right: 8px; color: #4caf50;"></i> ${ownerName}</p>
                                        <p style="margin: 5px 0;"><i class="fas fa-phone" style="margin-right: 8px; color: #4caf50;"></i> ${ownerPhone || 'Phone not available'}</p>
                                    </div>
                                    <div style="margin-top: 24px;">
                                         ${ownerPhone ? `
                                         <a href="tel:${String(ownerPhone).replace(/[^0-9+]/g, '')}" 
                                            style="display: inline-block; background: #4caf50; color: white; text-decoration: none; padding: 10px 20px; border-radius: 6px; font-weight: 500; margin: 0 5px;">
                                             <i class="fas fa-phone-alt" style="margin-right: 8px;"></i>Call Now
                                         </a>` : ''}
                                        <button onclick="document.querySelector('.contact-modal').remove()" 
                                                style="background: #f1f1f1; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin: 0 5px;">
                                            Close
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                        document.body.insertAdjacentHTML('beforeend', modalHtml);
                        break;
                    case 'chat':
                        openChatPopup(itemName, ownerName, itemId, ownerId);
                        break;
                    case 'cancel':
                        break;
                }
            };

            let currentChatOwnerId = null;
            let currentItemId = null;

            window.openChatPopup = function(itemName, ownerName, itemId, ownerId) {
                const chatPopup = document.getElementById('chatPopup');
                const chatTitle = document.getElementById('chatTitle');
                const chatBody = document.getElementById('chatBody');

                if (currentChatOwnerId && (currentChatOwnerId !== ownerId || currentItemId !== itemId)) {
                    closeChatPopup();
                }

                chatTitle.textContent = `Chat with ${ownerName} about ${itemName}`;
                currentChatOwnerId = ownerId;
                currentItemId = itemId;

                console.log(`Fetching chat history: itemId=${itemId}, senderId=${currentUserId}, receiverId=${ownerId}`);

                fetch(`/user/community/${communityId}/items/chat/history?itemId=${itemId}&senderId=${currentUserId}&receiverId=${ownerId}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(messages => {
                    console.log('Chat history received:', messages);
                    chatBody.innerHTML = '';
                    if (messages.length === 0) {
                        chatBody.innerHTML = '<div class="chat-message received">No previous messages.</div>';
                    } else {
                        messages.forEach(msg => {
                            const isSent = msg.sender.id === currentUserId;
                            const messageHtml = `
                                <div class="chat-message ${isSent ? 'sent' : 'received'}">
                                    ${msg.message}
                                </div>
                            `;
                            chatBody.insertAdjacentHTML('beforeend', messageHtml);
                        });
                    }
                    chatBody.scrollTop = chatBody.scrollHeight;
                })
                .catch(error => {
                    console.error('Error loading chat history:', error);
                    chatBody.innerHTML = `<div class="chat-message received">Error loading chat history: ${error.message}</div>`;
                });

                chatPopup.classList.add('show');
            };

            window.closeChatPopup = function() {
                const chatPopup = document.getElementById('chatPopup');
                const chatBody = document.getElementById('chatBody');
                chatPopup.classList.remove('show');
                chatBody.innerHTML = '';
                currentChatOwnerId = null;
                currentItemId = null;
            };

            window.sendMessage = function() {
                const chatInput = document.getElementById('chatInput');
                const chatBody = document.getElementById('chatBody');
                const messageText = chatInput.value.trim();

                if (messageText && currentItemId && currentChatOwnerId) {
                    const messageHtml = `
                        <div class="chat-message sent">
                            ${messageText}
                        </div>
                    `;
                    chatBody.insertAdjacentHTML('beforeend', messageHtml);
                    chatInput.value = '';

                    chatBody.scrollTop = chatBody.scrollHeight;

                    console.log(`Sending message: itemId=${currentItemId}, senderId=${currentUserId}, receiverId=${currentChatOwnerId}, message=${messageText}`);

                    fetch(`/user/community/${communityId}/items/chat/send`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `itemId=${currentItemId}&senderId=${currentUserId}&receiverId=${currentChatOwnerId}&message=${encodeURIComponent(messageText)}`
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        return response.text();
                    })
                    .then(result => {
                        console.log('Message sent successfully:', result);
                    })
                    .catch(error => {
                        console.error('Error sending message:', error);
                        chatBody.insertAdjacentHTML('beforeend', `<div class="chat-message received">Error sending message: ${error.message}</div>`);
                    });
                } else {
                    console.warn('Cannot send message: Missing itemId or ownerId');
                }
            };
        });
    </script>
</body>
</html>